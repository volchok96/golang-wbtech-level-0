# Демонстрационный Сервис Обработки Заказов

Сервис обработки заказов - это демонстрационный сервис для управления и отображения данных о заказах. Сервис подключается к базе данных PostgreSQL, подписывается на Kafka для получения данных о заказах, кэширует данные в памяти и предоставляет HTTP API для получения информации о заказах по их идентификаторам.

## Возможности

- **Интеграция с PostgreSQL:** Хранение данных о заказах в базе данных PostgreSQL.
- **Apache Kafka:** Подписка на брокер сообщений Kafka для получения данных о заказах.
- **Кэширование в памяти:** Кэширование данных о заказах в памяти для быстрого доступа.
- **HTTP API:** Предоставление API для получения информации о заказах по их идентификаторам.
- **Устойчивость:** Восстановление кэша из базы данных в случае перезапуска сервиса.
- **Нагрузочное тестирование:** Поддержка нагрузочного тестирования с использованием WRK и Vegeta.
- **Интеграционное тестирование:** Поддержка интеграционных тестов **с покрытием 26%**.
- **Docker-контейнеризация:** Удобство развертывания сервисов для тестирования через docker-compose.
- **Система логирования**: Логи в JSON-формате для удобства машинной обработки.
- **Валидация данных:** Многоступенчатая система проверки и валидации данных перед их попаданием в кэш, БД и топик брокера сообщений.

## Требования

- Go 1.22.2
- PostgreSQL
- Kafka & Zookeper
- Memcached
- WRK (для нагрузочного тестирования)
- Vegeta (для нагрузочного тестирования)
- Docker, docker-compose

## Установка

1. Клонируйте репозиторий:
   ```sh
   git clone https://github.com/volchok96/golang-wbtech-level-0.git
   cd golang-wbtech-level-0
   ```

2. Установите зависимости:
   ```sh
   go mod tidy
   ```
   
## Конфигурация

1. **Для локального запуска:** Создайте файл конфигурации в корневой директории проекта с именем `config.local.yaml`:

    ```yaml
    kafka:
      broker: "localhost:9092"  
      group_id: "order-group"
      topic: "orders"   

    postgres:
      host: "localhost"
      port: 5432    
      user: "postgres"
      password: "mypass"
     dbname: "orderdb"

    memcached:
      host: "localhost"
      port: "11211"

    ```
2. **Для запуска в Docker:** Создайте файл конфигурации в корневой директории проекта с именем `config.docker.yaml` (Kafka будет развернут локально):

    ```yaml
    kafka:
      broker: "localhost:9092"  
      group_id: "order-group"
      topic: "orders"   

    postgres:
      host: "db"
      port: 5432    
      user: "postgres"
      password: "mypass"
     dbname: "orderdb"

    memcached:
      host: "memcached"
      port: "11211"

    ```

## Настройка базы данных

1. Создайте БД orderdb:
  ```sql
  CREATE DATABASE orderdb;
  ```

2. Выполните начальную миграцию с помощью скрипта [SQL](migrations/000001_init_db.up.sql) в директории migrations/.

## Использование сервиса

Данные о заказе доступны по адресу: 

[http://localhost:8080/order?id=1]

В параметр id GET-запроса необходимо подставить ID требующегося заказа.
При переходе по ссылке выше отобразится информация о заказе с id = 1.

## Запуск сервиса в локальной среде

1. Запустите сервис обработки заказов:

    ```sh
    make run
    ```

2. Запустите сервис отправки уведомления:

    ```sh
    make notify
    ```

### Использование WRK
Для тестирования конечной точки публикации заказов с помощью WRK

1. Запустите нагрузочный тест:

    ```sh
    make wrk-local
    ```

### Использование Vegeta

Для тестирования конечной точки публикации заказов с помощью Vegeta:

1. Запустите нагрузочный тест:

    ```sh
    make vegeta-local
    ```

Это создаст отчет.

### Запуск тестов

Чтобы запустить интеграционные тесты:

```sh
make test-integration
```

Для запуска и генерации отчета по нагрузочному тестированию:

```sh
make test-local
```

## Запуск сервиса в среде Docker

1. Соберите Docker-образы с использованием переменной окружения APP_ENV=docker и запустите конейнеры в фоновом режиме:

    ```sh
    make docker
    ```

2. Запустите сервис:

    ```sh
    make run
    ```

### Использование WRK
Для тестирования конечной точки публикации заказов с помощью WRK

1. Запустите нагрузочный тест:

    ```sh
    make wrk-docker
    ```

### Использование Vegeta

Для тестирования конечной точки публикации заказов с помощью Vegeta:

1. Запустите нагрузочный тест:

    ```sh
    make vegeta-docker
    ```

Это создаст отчет.

### Запуск тестов

Для запуска и генерации отчета по нагрузочному тестированию:

```sh
make test-docker
```

## Лицензия
Этот проект лицензирован под MIT License.

## Контакты

Если у вас есть вопросы или предложения, пожалуйста, свяжитесь со мной:
- Email: kzakharova96@yandex.com
- TG: https://t.me/volchok_96

## Благодарности
Спасибо всем, кто внес свой вклад в развитие этого проекта!

### Идея проекта:
- https://tech.wildberries.ru/

### Техническое сопровождение:
- https://21-school.ru/
